<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Secure Uploader{% endblock %}</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding-top: 64px; background: linear-gradient(180deg,#f7fbff 0%, #ffffff 40%); }
      .brand { font-weight: 700; letter-spacing: .4px; }
      .card-table td, .card-table th { vertical-align: middle; }
      .flash-list { list-style: none; padding-left: 0; }
      .site-hero { background: linear-gradient(135deg, rgba(2,48,71,0.95), rgba(4,102,142,0.95)); color: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 6px 30px rgba(2,48,71,0.12); }
      .site-hero p { color: rgba(255,255,255,0.9); }
      .card { border-radius: 10px; box-shadow: 0 6px 18px rgba(2,48,71,0.06); }
      .secure-lock { display:inline-flex; align-items:center; gap:.45rem; padding:.25rem .5rem; border-radius:999px; }
      .secure-lock .lock-icon { width:20px; height:20px; display:inline-block }
      .secure-lock.locked { background: rgba(23,163,74,0.12); color: #137a3f; }
      .secure-lock.unlocked { background: rgba(250,180,45,0.10); color: #8a5b00; }
      .secure-lock .dot { width:8px; height:8px; border-radius:50%; display:inline-block }
      .secure-lock.locked .dot { background:#16a34a }
      .secure-lock.unlocked .dot { background:#f59e0b }
      /* Floating action button to quickly view files */
      .fab-files {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 1050;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      }
      .fab-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545;
        color: white;
        width:20px;
        height:20px;
        font-size:12px;
        border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        box-shadow:0 3px 8px rgba(0,0,0,0.12);
      }
      /* digital lock animation */
      @keyframes blinkDot { 0%,100%{opacity:1}50%{opacity:0.15} }
      .digital-lock svg .blink { animation: blinkDot 1.6s infinite; }
    </style>
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
      <div class="container">
        <a class="navbar-brand brand" href="{{ url_for('index') }}">Secure Uploader</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMenu">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('upload') }}">Upload</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('files') }}">Files</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('inbox') }}">Inbox</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('add_user_form') }}">Add User</a></li>
            <li class="nav-item d-flex align-items-center ms-3">
              {% if ENCRYPTION_AVAILABLE %}
                <div class="secure-lock locked" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Server encryption enabled — files are encrypted at rest.">
                  <svg class="lock-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" fill="currentColor"/><path d="M7 10V8a5 5 0 1110 0v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="10" width="16" height="10" rx="2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <span class="d-none d-lg-inline">Secure</span>
                </div>
              {% else %}
                <div class="secure-lock unlocked" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Server encryption not configured — consider setting UPLOAD_ENC_KEY.">
                  <svg class="lock-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10V8a5 5 0 0110 0v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="10" width="16" height="10" rx="2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <span class="d-none d-lg-inline">Not Secure</span>
                </div>
              {% endif %}
            </li>
            {% if g.user %}
              <li class="nav-item"><span class="nav-link">{{ g.user.username }}</span></li>
              <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="mt-2">
            <ul class="flash-list">
              {% for m in messages %}
                <li class="alert alert-info">{{ m }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>
    <!-- Floating View Files button (accessible, present on every page) -->
    <a class="btn btn-primary fab-files" href="{{ url_for('files') }}" title="View Files" aria-label="View uploaded files">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: #fff;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
      </svg>
      {% if FILE_COUNT and FILE_COUNT > 0 %}
        <span class="fab-badge" aria-hidden="true">{{ FILE_COUNT if FILE_COUNT < 100 else '99+' }}</span>
      {% endif %}
    </a>

    <!-- Lock details modal -->
    <div class="modal fade" id="lockModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Encryption Status</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if ENCRYPTION_AVAILABLE %}
              <p>Your server is configured with an encryption key. Files uploaded without client-side encryption are encrypted at rest on the server.</p>
            {% else %}
              <p>The server does not have an `UPLOAD_ENC_KEY` configured. Files uploaded without client-side encryption will be stored unencrypted. To enable server-side encryption, set an environment variable named <code>UPLOAD_ENC_KEY</code> with a base64 urlsafe key (32 bytes) and restart the app.</p>
              <pre class="small"># Example (PowerShell)
 $k = [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 } | ForEach-Object {[byte]$_}));
 setx UPLOAD_ENC_KEY $k
              </pre>
            {% endif %}
            <hr>
            <p class="small text-muted">If you prefer client-side encryption, use the "Encrypt in browser" option on the Upload page. The server will store the encrypted blob as-is.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // initialize Bootstrap tooltips
      document.addEventListener('DOMContentLoaded', function(){
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
      })
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
